2005-06-05  Timo Schulz  <ts@g10code.com>

	* passphrase-dialog.c (load_recipbox): Check ctx if null.
	(passphrase_callback_box): Different dialogs for sign
	and decrypt.
	(signer_dialog_box): Do not zero the context too early.
	* keycache.c (enum_gpg_seckeys): Also reload if ctx
	is NULL.
	* MapiGPGME.cpp (signEncrypt): Return if the user
	cancelled the signer selection dialog.	 
	* recipient-dialog.c (recipient_dlg_proc): Check 'Text Mode'
	button.
	* keycache.c (enum_gpg_keys, enum_gpg_seckeys): Fully
	reset the keycache initializing it again. Thanks to Ralf.

2005-06-04  Timo Schulz  <ts@g10code.com>

	* verify-dialog.c (load_sigbox): Only issue a warning
	if the key exists but is not valid.
	Get pkalgo from the signature.
	Fixed format string problem s/%d/%s.	
	* config-dialog.c (load_config_value): Close reg handle.
	(config_dlg_proc): Show error if the values could not
	be written to the registry.

2005-06-03  Timo Schulz  <ts@g10code.com>

	* mapuser.c (new_usermap): New.
	(free_usermap): New.
	* engine-gpgme.c (op_decrypt): Return 'No_Seckey' if
	appropriate and not just 'Decrypt_Failed'.
	Set the gpgme_ctx_t object in the callback to allow
	to list the 'encrypt_to' entries.
	* passphrase-dialog.c (decrypt_key_dlg_proc): Make sure
	we only warn when there is a valid callback context.
	(load_secbox): New parameter 'ctlid'. Changed all callers.
	(load_recipbox): New. Use usermap to lookup user-id's.
	(decrypt_key_ext_dlg_proc): New dialog procedure for
	the callback mode.
	* HashTable.cpp (HashTable_new): New. C-interface.
	(HashTable_free): Likewise.
	(HashTable_get): Likewise.
	(HashTable_put): Likewise.
	(HashTable_get_i): Likewise.
	(HashTable_size): Likewise.

2005-05-29  Timo Schulz  <ts@g10code.com>

	* passphrase-dialog.c (decrypt_key_dlg_proc): Warning
	if the user cancels the signing process.
	Make the passphrase field invisible if the key is used
	in selection mode.
	(recipient_dlg_proc): Likewise.
	(signer_dialog_box): Return -1 if the user cancelled the
	dialog.
	* engine-gpgme.c (op_sign): Set flags to '1' to indicate
	signing process.
	* config-dialog.c (does_file_exist): Use appropriate
	length for xmalloc. Noted by Sebastian.

2005-05-24  Timo Schulz  <ts@g10code.com>

	* MapiGPGME.cpp (setXHeader): New.
	(getXHeader): New.
	* engine-gpgme.c (op_sign_file): Implemented.

2005-05-22  Timo Schulz  <ts@g10code.com>

	* MapiGPGME.cpp (createAttachment): New.
	(deleteAttachment): New.
	(encryptAttachments): New.
	(encrypt): Also encrypt the attachments if possible.
	(signEncrypt): Likewise.
	(setEncodingFormat): New.
	(getEncodingFormat): New.
	(readOptions, writeOptions): Store encoding format.
	(MapiGPGME): The default encoding is 'CLASSIC'.

2005-05-21  Timo Schulz  <ts@g10code.com>

	* HashTable.h: Export functions.
	* MapiGPGME.cpp (freeAttachments): New.
	(getAttachments): New.
	(openAttachment): New.
	(closeAttachment): New.
	(processAttachment): New.
	(hasAttachments): New.
	(countAttachments): New.
	(doCmdFile): New. Can handle files.
	(doCmdAttach): New. Can handle attachment action types.
	(signEncrypt): Release locusr key.
	* engine-gpgme.c (op_sign_file): New. Dummy.
	(op_sign_encrypt_file): New. Dummy.

2005-05-11  Timo Schulz  <ts@g10code.com>

	* common.c (cache_item_new): New.
	(cache_item_free): New.
	* engine-gpgme.c (op_decrypt_start_ext): Return an cache item and
	not just the passphrase. Changed all caller.
	* MapiGPGME.cpp (passphraseCallback): Support caching.
	(decrypt): Likewise.
	(storePassphrase): Likewise.
	(getPassphrase): Likewise.
	* HashTable.cpp: New.

2005-05-10  Timo Schulz  <ts@g10code.com>

	* passphrase-dialog.c (decrypt_key_dlg_proc): Reset 'hide state'.
	Show some text when the user entered a wrong passphrase.
	* MapiGPGME.cpp (findMessageWindow): New.
	(setRTFBody): New.
	(decrypt): Just change the window text, not the MAPI object.
	Call verify() if this is a clearsigned message.
	(getMessageType): New.
	(getAttachmentExtension): New.
	(verify): Extract text and set it.
	* engine-gpgme.c (op_decrypt): Spawn verify dialog if the text
	was also signed.
	(op_decrypt_file): New.
	* verify-dialog.c (load_sigbox): Avoid key cache and give more
	information.	
	* passphrase-dialog.c (decrypt_key_dlg_proc): Handle 'x' clicks.
	* logging.c (log_debug): Disable it for release versions.

2005-05-08  Timo Schulz  <ts@g10code.com>

	* MapiGPGME.cpp (readOptions): Handle logfile.
	(writeOptions): Likewise.
	(storePassphrase): New.
	(clearPassphrase): New.
	(passphraseCallback): New. Needs to be static...
	(decrypt): Store passphrase if requested.
	(~MapiGPGME): Free memory.
	(streamOnFile): New.
	(getAttachMethod): New.
	(getAttachFilename): New.
	(setAttachMethod): New.
	(getAttachFilename): New.
	(getMessageHasAttachments): New.
	(getMessageFlags): New.

	* engine-gpgme.c (op_decrypt): New. Factoured out
	code from...
	(op_decrypt_start): ..here. Now call op_decrypt
	with standard parameters.
	(op_decrypt_next): Allow to use a pre-defined 
	passphrase callback. Needed for caching.

2005-05-02  Timo Schulz  <ts@g10code.com>

	* MapiGPGME.cpp (fail_if_null, delete_buf): New
	(doCmd): New.
	(setBody): If the body to set is empty, do nothing.
	(freeKeyArray): New.
	(readOptions): New.
	(writeOptions): New.
	Implement all getters and setters for the config code.

	* keycache.c: Now that we use a DLL, we create a
	shared data segment for static data.
	(load_keycache_objects): New.

2005-05-01  Timo Schulz  <ts@g10code.com>

	* MapiGPGME.cpp (rtfSync): New.
	* logging.c (log_debug): New.
	* common.c (xfree): New.
	* engine-gpgme.c (op_lookup_keys): Corrected offsets.

2005-04-29  Timo Schulz  <ts@g10code.com>

	* engine-gpgme.c (op_encrypt_file): New.

2005-04-27  Timo Schulz  <ts@g10code.com>

	* config-dialog.c (config_dialog_box): Add dialog
	item to select a GUI key manager.
	Check that the entered files really exist.
	(config_dlg_proc): Likewise.
	(does_file_exist): New.

2005-04-24  Timo Schulz  <ts@g10code.com>

	* main.c (DllMain): New. With a static library it was not
	possible to have a separate resource file. Thus we use a
	DLL now which contains all needed dialogs.
	* common.c (set_global_hinstance): New.
	* libgpgmedlgs.def: New.

2005-04-18  Timo Schulz  <ts@g10code.com>

	* recipient-dialog.c (recipient_dialog_box2): New
	way to show pre-selected keys.
	(copy_item): New paramenter for the pos.
	(find_item): Do not select the item.

	* gpgmedlgs.rc (IDD_ENC): New label to describe
	the listbox.

2005-04-15  Timo Schulz  <ts@g10code.com>

	* common.c (xmalloc, xcalloc, xstrdup): New.
	(out_of_core): New.
	* recipient-dialog.c (initialize_keybox): New.
	(find_item): New.
	* MapiGPGME.cpp (freeUnknownKeys): New.
	(signEncrypt): Show dialog to select a key if no
	default key was set.

	* Replace all std-c alloc functions with x equivalents.

2005-04-13  Timo Schulz  <ts@g10code.com>

	* engine-gpgme.c (do_init): Alloc keycache objects.
	(do_deinit): Cleanup the mess.
	(op_lookup_keys): New. Allow to find keys via the email.

	* GPGME.cpp (MapiGPGME): New. MAPI interface.

2005-04-07  Timo Schulz  <ts@g10code.com>

	* verify-dialog.c (load_akalist): New.
	(load_sigbox): Handle bad signatures.
	* keycache.c (enum_gpg_keys): Allow to reset the
	enum context.
	* config-dialog.c (get_open_file_name): Use MAX_PATH.
	(get_folder): Likewise.
	* recipient-dialog.c (load_rsetbox): Modify code to
	add the last keycache item.
	* passphrase-dialog.c (load_secbox): Likewise.
